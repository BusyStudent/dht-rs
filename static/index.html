<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHT Crawler - æ§åˆ¶é¢æ¿</title>
    <style>
        /* --- åŸºæœ¬æ ·å¼ --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- å·¦ä¾§ Tab å¯¼èˆª --- */
        .tab-container {
            flex: 0 0 180px;
            background-color: #2c3e50;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
        }

        .tab-button {
            background-color: transparent;
            color: #ecf0f1;
            border: none;
            padding: 15px 20px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s, color 0.3s;
            border-left: 4px solid transparent;
        }

        .tab-button:hover {
            background-color: #34495e;
        }

        .tab-button.active {
            background-color: #3498db;
            color: #ffffff;
            border-left: 4px solid #ffffff;
        }
        
        /* --- å³ä¾§å†…å®¹åŒºåŸŸ --- */
        .content-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .tab-content {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .tab-content.active {
            display: flex;
        }

        /* --- é€šç”¨ç»„ä»¶æ ·å¼ --- */
        h2 {
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            color: #2c3e50;
            margin-top: 0;
        }

        .button {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        .button:hover {
            background-color: #2980b9;
        }

        .button.danger {
            background-color: #e74c3c;
        }
        .button.danger:hover {
            background-color: #c0392b;
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* --- ç‰¹å®šç•Œé¢æ ·å¼ --- */

        /* ä¸»ç•Œé¢ */
        #log-window {
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            background-color: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            overflow-y: scroll;
            font-family: "Courier New", Courier, monospace;
            white-space: pre-wrap;
        }

        /* è·¯ç”±è¡¨ */
        #routing-table-list {
            list-style-type: none;
            padding: 0;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
            overflow-y: auto;
        }
        #routing-table-list li {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
        }
        #routing-table-list li:last-child {
            border-bottom: none;
        }
        
        /* å…ƒæ•°æ®æŸ¥æ‰¾ */
        #metadata-content .scrollable-area {
            flex: 1;
            overflow-y: auto;
            padding-right: 15px; /* for scrollbar */
        }
        #search-results {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .torrent-card {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        .torrent-card.minimal {
            background-color: #f9f9f9;
        }
        .torrent-card h4 {
            margin: 0 0 10px 0;
            word-break: break-all;
            color: #2c3e50;
        }
        .torrent-card.minimal h4 {
            color: #7f8c8d;
            font-style: italic;
        }
        .torrent-card .info-hash {
            font-family: monospace;
            font-size: 12px;
            color: #555;
            word-break: break-all;
            margin-bottom: 15px;
        }
        .torrent-card .actions {
            margin-top: auto;
            display: flex;
            gap: 10px;
        }
        .torrent-card .actions .button {
            flex: 1;
            padding: 8px;
            font-size: 14px;
        }
        
        /* --- æ–‡ä»¶æ ‘çŠ¶åˆ—è¡¨æ ·å¼ --- */
        .file-list {
            display: none; /* é»˜è®¤éšè— */
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
            max-height: 250px;
            overflow-y: auto;
            font-size: 14px;
        }
        /* [BUGä¿®å¤] æ–°å¢ .is-shown ç±»ç”¨äºæ˜¾ç¤º */
        .file-list.is-shown {
            display: block;
        }
        .file-list ul, .file-list li {
            list-style-type: none;
            padding-left: 0;
        }
        .file-list ul {
            padding-left: 20px;
        }
        .file-list li {
             padding: 3px 0;
        }
        .tree-item {
            cursor: default;
        }
        .tree-item::before {
            margin-right: 8px;
            display: inline-block;
            width: 1.2em;
            font-family: 'Courier New', Courier, monospace;
        }
        .tree-folder {
            font-weight: 500;
            cursor: pointer;
            color: #2980b9;
        }
        .tree-folder::before {
            content: 'â–¸'; /* æŠ˜å çŠ¶æ€ */
        }
        .tree-file::before {
            content: 'ğŸ“„';
        }
        .file-size {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-left: 8px;
        }
        /* å±•å¼€/æŠ˜å  é€»è¾‘ */
        .tree-folder-container > ul {
            display: none; /* å­åˆ—è¡¨é»˜è®¤éšè— */
        }
        .tree-folder-container.expanded > .tree-folder::before {
            content: 'â–¾'; /* å±•å¼€çŠ¶æ€ */
        }
        .tree-folder-container.expanded > ul {
            display: block; /* æ˜¾ç¤ºå±•å¼€çš„å­åˆ—è¡¨ */
        }

        /* ç¿»é¡µæ§ä»¶ */
        #pagination-controls {
            margin-top: 20px;
            padding-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        .pagination-link {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #3498db;
            text-decoration: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .pagination-link:hover {
            background-color: #f0f0f0;
        }
        .pagination-link.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        .pagination-link.disabled {
            color: #aaa;
            cursor: not-allowed;
            background-color: #f5f5f5;
        }

        /* --- [æ–°å¢] æ‰‹åŠ¨å·¥å…·æ ·å¼ --- */
        .tool-section {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .tool-section h3 {
            margin-top: 0;
            color: #3498db;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 10px;
            font-size: 18px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .input-group input {
            flex-grow: 1;
            margin-bottom: 0; /* Override form-group's margin on input */
        }
        .input-group .button {
            flex-shrink: 0; /* Prevent random button from shrinking */
            padding: 10px; /* Make it same height as input */
        }
        .tool-response {
            background-color: #2c3e50; /* Darker background */
            color: #ecf0f1; /* Lighter text */
            border: 1px solid #34495e;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            min-height: 60px;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: "Courier New", Courier, monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <!-- å·¦ä¾§ Tab æ  -->
    <div class="tab-container">
        <button class="tab-button active" onclick="showTab('main')">ä¸»ç•Œé¢</button>
        <button class="tab-button" onclick="showTab('routing')">è·¯ç”±è¡¨</button>
        <button class="tab-button" onclick="showTab('metadata')">å…ƒæ•°æ®æŸ¥æ‰¾</button>
        <button class="tab-button" onclick="showTab('settings')">è®¾ç½®</button>
        <!-- [æ–°å¢] å·¥å…· Tab -->
        <button class="tab-button" onclick="showTab('tools')">å·¥å…·</button>
    </div>

    <!-- å³ä¾§å†…å®¹åŒº -->
    <div class="content-container">
        <!-- ä¸»ç•Œé¢ -->
        <div id="main-content" class="tab-content active">
            <h2>ä¸»ç•Œé¢</h2>
            <div>
                <button id="start-btn" class="button">å¯åŠ¨çˆ¬è™«</button>
                <button id="stop-btn" class="button danger" style="display: none;">åœæ­¢çˆ¬è™«</button>
            </div>
            <h3 style="margin-top: 20px; margin-bottom: 10px;">æ—¥å¿—è¾“å‡º</h3>
            <div id="log-window"></div>
        </div>

        <!-- è·¯ç”±è¡¨ -->
        <div id="routing-content" class="tab-content">
            <h2>è·¯ç”±è¡¨ (K-Buckets)</h2>
            <p>å½“å‰è·¯ç”±è¡¨ä¸­çš„èŠ‚ç‚¹æ•°é‡: <span id="node-count">0</span></p>
            <ul id="routing-table-list"></ul>
        </div>

        <!-- å…ƒæ•°æ®æŸ¥æ‰¾ -->
        <div id="metadata-content" class="tab-content">
            <h2>å…ƒæ•°æ®æŸ¥æ‰¾</h2>
            <input type="text" id="search-input" placeholder="è¾“å…¥ Info Hash æˆ– ç§å­åç§°å…³é”®å­— *é€‰æ‹©æ‰€æœ‰ï¼Œåœæ­¢è¾“å…¥åè‡ªåŠ¨æœç´¢...">
            <div class="scrollable-area">
                <div id="search-results"></div>
            </div>
            <div id="pagination-controls"></div>
        </div>

        <!-- è®¾ç½® -->
        <div id="settings-content" class="tab-content">
            <h2>è®¾ç½®</h2>
            <div class="form-group">
                <label for="webui-port-input">WebUI ç»‘å®šç«¯å£</label>
                <input type="number" id="webui-port-input" placeholder="ä¾‹å¦‚: 10721 Cialloï½(âˆ ãƒ»Ï‰< )">
            </div>
            <div class="form-group">
                <label for="bind-addr-input">DHT ç»‘å®šåœ°å€</label>
                <input type="text" id="bind-addr-input" placeholder="ä¸å¯ä»¥ä¸ºç©º">
            </div>
            <div class="form-group">
                <label for="node-id-input">èŠ‚ç‚¹ID (Node ID)</label>
                <input type="text" id="node-id-input" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ">
            </div>
            <button id="save-settings-btn" class="button">ä¿å­˜è®¾ç½®</button>
        </div>
        
        <!-- [æ–°å¢] å·¥å…·ç•Œé¢ -->
        <div id="tools-content" class="tab-content">
            <h2>æ‰‹åŠ¨å·¥å…·</h2>
            <p>ç”¨äºæ‰‹åŠ¨å‘ DHT ç½‘ç»œä¸­çš„ç‰¹å®šèŠ‚ç‚¹å‘é€è¯·æ±‚ï¼Œä»¥è¿›è¡Œè°ƒè¯•ã€‚</p>
            
            <div class="tool-section">
                <h3>Ping èŠ‚ç‚¹</h3>
                <div class="form-group">
                    <label for="tools-ping-addr-input">èŠ‚ç‚¹åœ°å€ (IP:Port)</label>
                    <input type="text" id="tools-ping-addr-input" placeholder="ä¾‹å¦‚: 123.45.67.89:6881">
                </div>
                <button class="button tool-btn" data-tool="ping">å‘é€ Ping</button>
                <pre id="tools-ping-response" class="tool-response">å“åº”å°†æ˜¾ç¤ºåœ¨æ­¤å¤„</pre>
            </div>
        
            <div class="tool-section">
                <h3>Get Peers</h3>
                <div class="form-group">
                    <label for="tools-getpeers-addr-input">èŠ‚ç‚¹åœ°å€ (IP:Port)</label>
                    <input type="text" id="tools-getpeers-addr-input" placeholder="ç›®æ ‡èŠ‚ç‚¹åœ°å€">
                </div>
                <div class="form-group">
                    <label for="tools-getpeers-hash-input">Info Hash (40ä¸ªåå…­è¿›åˆ¶å­—ç¬¦)</label>
                    <div class="input-group">
                        <input type="text" id="tools-getpeers-hash-input">
                        <button class="button random-btn" data-random-for="tools-getpeers-hash-input">éšæœº</button>
                    </div>
                </div>
                <button class="button tool-btn" data-tool="get_peers">å‘é€ Get Peers</button>
                <pre id="tools-get-peers-response" class="tool-response">å“åº”å°†æ˜¾ç¤ºåœ¨æ­¤å¤„</pre>
            </div>
        
            <div class="tool-section">
                <h3>Announce Peer</h3>
                <div class="form-group">
                    <label for="tools-announce-addr-input">èŠ‚ç‚¹åœ°å€ (IP:Port)</label>
                    <input type="text" id="tools-announce-addr-input" placeholder="ç›®æ ‡èŠ‚ç‚¹åœ°å€">
                </div>
                <div class="form-group">
                    <label for="tools-announce-hash-input">Info Hash (40ä¸ªåå…­è¿›åˆ¶å­—ç¬¦)</label>
                    <div class="input-group">
                        <input type="text" id="tools-announce-hash-input">
                        <button class="button random-btn" data-random-for="tools-announce-hash-input">éšæœº</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="tools-announce-port-input">æˆ‘æ–¹ Peer ç«¯å£</label>
                    <input type="number" id="tools-announce-port-input" placeholder="ä¾‹å¦‚: 6881">
                </div>
                <button class="button tool-btn" data-tool="announce_peer">å‘é€ Announce Peer</button>
                <pre id="tools-announce-peer-response" class="tool-response">å“åº”å°†æ˜¾ç¤ºåœ¨æ­¤å¤„</pre>
            </div>
        
            <div class="tool-section">
                <h3>Sample Infohashes</h3>
                <div class="form-group">
                    <label for="tools-sample-addr-input">èŠ‚ç‚¹åœ°å€ (IP:Port)</label>
                    <input type="text" id="tools-sample-addr-input" placeholder="ç›®æ ‡èŠ‚ç‚¹åœ°å€">
                </div>
                <div class="form-group">
                    <label for="tools-sample-target-input">ç›®æ ‡ Node ID (40ä¸ªåå…­è¿›åˆ¶å­—ç¬¦)</label>
                    <div class="input-group">
                        <input type="text" id="tools-sample-target-input">
                        <button class="button random-btn" data-random-for="tools-sample-target-input">éšæœº</button>
                    </div>
                </div>
                <button class="button tool-btn" data-tool="sample_infohashes">å‘é€ Sample Infohashes</button>
                <pre id="tools-sample-infohashes-response" class="tool-response">å“åº”å°†æ˜¾ç¤ºåœ¨æ­¤å¤„</pre>
            </div>
        </div>

    </div>

<script>
    // --- å…¨å±€å˜é‡å’Œåˆå§‹åŒ– ---
    let searchDebounceTimer; // ç”¨äºæœç´¢é˜²æŠ–çš„è®¡æ—¶å™¨
    let routingTableTimer;   // ç”¨äºæ›´æ–°è·¯ç”±è¡¨çš„è®¡æ—¶å™¨
    let currentQuery = '';   // å½“å‰æœç´¢çš„å…³é”®è¯
    let currentPage = 1;     // å½“å‰æœç´¢çš„é¡µç 

    document.addEventListener('DOMContentLoaded', () => {
        loadSettings();
        addLog("æ¬¢è¿ä½¿ç”¨ DHT Indexer æ§åˆ¶é¢æ¿ã€‚");
        addLog("å‰ç«¯ç•Œé¢å·²å°±ç»ªï¼Œç­‰å¾…ä¸åç«¯äº¤äº’ã€‚");
        setupEventListeners();
        queryStatus();
    });

    // --- Tab åˆ‡æ¢é€»è¾‘ ---
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.getElementById(`${tabName}-content`).classList.add('active');
        document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
        if (routingTableTimer != null) {
            console.log('å…³é—­è·¯ç”±è¡¨è®¡æ—¶å™¨');
            clearInterval(routingTableTimer);
            routingTableTimer = null;
        }

        if (tabName === 'routing') {
            console.log('å¯åŠ¨è·¯ç”±è¡¨è®¡æ—¶å™¨');
            updateRoutingTable();
            routingTableTimer = setInterval(updateRoutingTable, 5000); // æ¯éš”5sæ›´æ–°ä¸€ä¸‹
        }
    }

    // --- äº‹ä»¶ç›‘å¬å™¨è®¾ç½® ---
    function setupEventListeners() {
        // å¯åŠ¨/åœæ­¢
        document.getElementById('start-btn').addEventListener('click', () => {
            startCrawler();
        });
        document.getElementById('stop-btn').addEventListener('click', () => {
            stopCrawler();
        });

        // æœç´¢æ¡†è¾“å…¥ï¼ˆé˜²æŠ–ï¼‰
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(searchDebounceTimer);
            const query = e.target.value.trim();
            searchDebounceTimer = setTimeout(() => {
                if (query !== currentQuery) {
                    currentQuery = query;
                    searchMetadata(1); // æ–°çš„æœç´¢æ€»æ˜¯ä»ç¬¬ä¸€é¡µå¼€å§‹
                }
            }, 250); // åœæ­¢è¾“å…¥250msåè§¦å‘
        });

        // ä¿å­˜è®¾ç½®
        document.getElementById('save-settings-btn').addEventListener('click', saveSettings);

        // æœç´¢ç»“æœåŒºåŸŸçš„äº‹ä»¶å§”æ‰˜ (å¤„ç†æŒ‰é’®ç‚¹å‡»å’Œæ–‡ä»¶æ ‘å±•å¼€/æŠ˜å )
        document.getElementById('search-results').addEventListener('click', (e) => {
            const target = e.target;

            // 1. å¤„ç†åŠŸèƒ½æŒ‰é’®ç‚¹å‡»
            const button = target.closest('button[data-action]');
            if (button) {
                const action = button.dataset.action;
                const hash = button.dataset.hash;
                
                if (action === 'copy-hash') {
                    navigator.clipboard.writeText(hash).then(() => alert(`Info Hash å·²å¤åˆ¶: ${hash}`));
                } else if (action === 'copy-magnet') {
                    const magnet = `magnet:?xt=urn:btih:${hash}`;
                    navigator.clipboard.writeText(magnet).then(() => alert(`ç£åŠ›é“¾æ¥å·²å¤åˆ¶: ${magnet}`));
                } else if (action === 'toggle-files') {
                    const fileList = button.closest('.torrent-card').querySelector('.file-list');
                    if (fileList) {
                       // [BUGä¿®å¤] æ”¹ä¸ºåˆ‡æ¢CSSç±»ï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œstyle
                       fileList.classList.toggle('is-shown');
                    }
                }
                return; // æŒ‰é’®äº‹ä»¶å·²å¤„ç†ï¼Œç»ˆæ­¢
            }

            // 2. å¤„ç†æ–‡ä»¶æ ‘æ–‡ä»¶å¤¹ç‚¹å‡»
            const folderToggle = target.closest('.tree-folder');
            if (folderToggle) {
                folderToggle.parentElement.classList.toggle('expanded');
            }
        });


        // ç¿»é¡µæ§ä»¶çš„äº‹ä»¶å§”æ‰˜
        document.getElementById('pagination-controls').addEventListener('click', (e) => {
            e.preventDefault();
            const target = e.target.closest('.pagination-link');
            if (!target || target.classList.contains('disabled') || target.classList.contains('active')) {
                return;
            }
            const page = parseInt(target.dataset.page, 10);
            searchMetadata(page);
        });

        // [æ–°å¢] æ‰‹åŠ¨å·¥å…·åŒºåŸŸçš„äº‹ä»¶å§”æ‰˜
        document.getElementById('tools-content').addEventListener('click', (e) => {
            const target = e.target;
    
            // å¤„ç† "éšæœº" æŒ‰é’®
            if (target.classList.contains('random-btn')) {
                const targetInputId = target.dataset.randomFor;
                if (targetInputId) {
                    const inputElement = document.getElementById(targetInputId);
                    if (inputElement) {
                        // Node ID å’Œ Info Hash éƒ½æ˜¯ 20 å­—èŠ‚
                        inputElement.value = generateRandomHex(20);
                    }
                }
            }
    
            // å¤„ç† "å‘é€" æŒ‰é’®
            if (target.classList.contains('tool-btn')) {
                const toolName = target.dataset.tool;
                handleToolRequest(toolName);
            }
        });
    }

    // --- ä¸åç«¯äº¤äº’çš„å‡½æ•° ---
    // çœ‹çœ‹æœ‰æ²¡æœ‰å·²ç»å¯åŠ¨äº†
    async function queryStatus() {
        try {
            const response = await fetch('/api/v1/is_dht_running');
            const running = await response.json();
            if (running) {
                document.getElementById('start-btn').style.display = 'none';
                document.getElementById('stop-btn').style.display = 'inline-block';
            }
            else {
                document.getElementById('stop-btn').style.display = 'none';
                document.getElementById('start-btn').style.display = 'inline-block';
            }
        }
        catch (e) {
            // ignore
        }
    }

    async function startCrawler() {
        if (document.getElementById('start-btn').style.display === 'none') {
            return; // æ—©å°±æœ‰ä¸ªä»»åŠ¡åœ¨å¯åŠ¨äº†
        }
        addLog("æ­£åœ¨å°è¯•å¯åŠ¨çˆ¬è™«...");
        try {
            const response = await fetch('/api/v1/start_dht');
            if (!response.ok) {
                addLog(`ä¸èƒ½è¿æ¥åˆ°åç«¯ å› ä¸º ${response.statusText}`);
                return;
            }
            const data = await response.text();
            addLog(`åç«¯è¿”å›: ${data}`);

            // æ˜¾ç¤ºåœæ­¢æŒ‰é’®ï¼Œéšè—å¼€å§‹æŒ‰é’®
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'inline-block';
        }
        catch (e) {
            console.log(e);
        }
    }
    async function stopCrawler() {
        if (document.getElementById('stop-btn').style.display === 'none') {
            return; // æ—©å°±æœ‰ä¸ªä»»åŠ¡åœ¨åœæ­¢äº†
        }
        addLog("æ­£åœ¨å‘é€åœæ­¢è¯·æ±‚...");
        try {
            const response = await fetch('/api/v1/stop_dht');
            if (!response.ok) {
                addLog(`ä¸èƒ½è¿æ¥åˆ°åç«¯ å› ä¸º ${response.statusText}`);
                return;
            }
            const data = await response.text();
            addLog(`åç«¯è¿”å›: ${data}`);

            // æ˜¾ç¤ºå¼€å§‹æŒ‰é’®ï¼Œéšè—åœæ­¢æŒ‰é’®
            document.getElementById('stop-btn').style.display = 'none';
            document.getElementById('start-btn').style.display = 'inline-block';
        }
        catch (e) {
            console.log(e);
        }
    }
    function addLog(message) {
        const logWindow = document.getElementById('log-window');
        const timestamp = new Date().toLocaleTimeString();
        logWindow.innerHTML += `[${timestamp}] ${message}\n`;
        logWindow.scrollTop = logWindow.scrollHeight;
    }
    async function updateRoutingTable() {
        const list = document.getElementById('routing-table-list');
        const countSpan = document.getElementById('node-count');
        try {
            // list.innerHTML = '<li>æ­£åœ¨ä»åç«¯è·å–æ•°æ®...</li>';
            // setTimeout(() => {
            //     const mockNodes = ['a1b2c3d4... | 192.168.1.10:6881','e5f6g7h8... | 8.8.8.8:6881','i9j0k1l2... | 202.108.22.5:12345'];
            //     list.innerHTML = mockNodes.map(node => `<li>${node}</li>`).join('');
            //     countSpan.textContent = mockNodes.length;
            // }, 1000);
            const response = await fetch('/api/v1/get_routing_table');
            if (!response.ok) {
                list.innerHTML = '<li>æ— æ³•è¿æ¥åˆ°åç«¯</li>';
                return;
            }
            const json = await response.json();
            list.innerHTML = json.map(node => `<li>${node.id} | ${node.ip}</li>`).join('');
            countSpan.textContent = json.length;
        }
        catch (e) {
            list.innerHTML = `<li>å‡ºé”™ ${e}</li>`;
        }
        
    }
    
    /**
     * å…ƒæ•°æ®æŸ¥æ‰¾: æ‰§è¡Œæœç´¢ (æ”¯æŒç¿»é¡µ)
     * @param {number} page - è¦è¯·æ±‚çš„é¡µç 
     */
    async function searchMetadata(page = 1) {
        currentPage = page;
        const resultsContainer = document.getElementById('search-results');

        if (!currentQuery) {
            resultsContainer.innerHTML = '';
            renderPaginationControls(0, 0);
            return;
        }

        resultsContainer.innerHTML = '<p>æ­£åœ¨æœç´¢, è¯·ç¨å€™...</p>';
        renderPaginationControls(0, 0); // æ¸…ç©ºæ—§çš„ç¿»é¡µ

        try {
            const response = await fetch('/api/v1/search_metadata', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: currentQuery, page: currentPage })
            });
            if (!response.ok) {
                 throw new Error(`HTTP error! status: ${response.status}`);
            }
            const json = await response.json();
            displaySearchResults(json.results);
            renderPaginationControls(json.totalPages, json.currentPage);
        }
        catch (e) {
            resultsContainer.innerHTML = `<p>æœç´¢å¤±è´¥: ${e}</p>`;
        }

        // console.log(`æ­£åœ¨æ¨¡æ‹Ÿæœç´¢: "${currentQuery}", ç¬¬ ${currentPage} é¡µ`);
        // setTimeout(() => {
        //      const mockFullData = {
        //         results: [
        //             {
        //                 name: 'ubuntu-22.04.3-desktop-amd64.iso',
        //                 info_hash: 'f8c0e6e7d4b3a299f1e9a217c5b3f0e8a1c2b3d4',
        //                 size: '4.7 GB',
        //                 files: [{ name: 'ubuntu.iso', size: '4.7 GB' }, { name: 'README.txt', size: '1.2 KB' }]
        //             },
        //             { // æ–°å¢ï¼šåªæœ‰ hash çš„æƒ…å†µ
        //                 info_hash: 'aabbccddeeff00112233445566778899aabbccdd'
        //             },
        //             {
        //                 name: '[Tears of Steel] a short film by the Blender Foundation',
        //                 info_hash: 'd8c0e6e7d4b3a299f1e9a217c5b3f0e8a1c2b3d9',
        //                 size: '522 MB',
        //                 files: [{ name: 'Tears of Steel.mp4', size: '520 MB' }, { name: 'poster.jpg', size: '2 MB' }]
        //             }
        //         ],
        //         totalPages: 5,
        //         currentPage: currentPage
        //     };
        //     displaySearchResults(mockFullData.results);
        //     renderPaginationControls(mockFullData.totalPages, mockFullData.currentPage);
        // }, 800);
    }
    
    /**
     * å°†æ‰å¹³çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆåŒ…å«è·¯å¾„ï¼‰è½¬æ¢ä¸ºåµŒå¥—çš„æ ‘å¯¹è±¡ã€‚
     * @param {Array<Object>} files - ä¾‹å¦‚ [{ name: 'dir/file.txt', size: '1KB' }]
     * @returns {Object} æ ‘çŠ¶ç»“æ„
     */
    function buildFileTree(files) {
        const tree = {};
        files.forEach(file => {
            const pathParts = file.name.split('/');
            let currentLevel = tree;

            pathParts.forEach((part, index) => {
                if (index === pathParts.length - 1) { // è·¯å¾„çš„æœ€åä¸€éƒ¨åˆ†æ˜¯æ–‡ä»¶
                    currentLevel[part] = { type: 'file', size: file.size };
                } 
                else { // è·¯å¾„çš„ä¸­é—´éƒ¨åˆ†æ˜¯æ–‡ä»¶å¤¹
                    if (!currentLevel[part]) {
                        currentLevel[part] = { type: 'folder', children: {} };
                    }
                    currentLevel = currentLevel[part].children;
                }
            });
        });
        return tree;
    }

    /**
     * å°†æ–‡ä»¶æ ‘å¯¹è±¡é€’å½’åœ°æ¸²æŸ“æˆHTMLå­—ç¬¦ä¸²ã€‚
     * @param {Object} treeNode - æ–‡ä»¶æ ‘çš„ä¸€ä¸ªèŠ‚ç‚¹
     * @returns {string} HTMLå­—ç¬¦ä¸²
     */
    function renderTreeToHTML(treeNode) {
        // æ’åºï¼Œä½¿æ–‡ä»¶å¤¹æ€»æ˜¯åœ¨æ–‡ä»¶å‰é¢
        const sortedKeys = Object.keys(treeNode).sort((a, b) => {
            const itemA = treeNode[a];
            const itemB = treeNode[b];
            const aIsFolder = itemA.type === 'folder';
            const bIsFolder = itemB.type === 'folder';

            if (aIsFolder && !bIsFolder) return -1;
            if (!aIsFolder && bIsFolder) return 1;
            return a.localeCompare(b); // åŒç±»å‹åˆ™æŒ‰å­—æ¯æ’åº
        });

        let html = '<ul>';
        for (const key of sortedKeys) {
            const item = treeNode[key];
            if (item.type === 'folder') {
                html += `<li class="tree-folder-container">
                            <span class="tree-item tree-folder">${key}</span>
                            ${renderTreeToHTML(item.children)}
                         </li>`;
            } else {
                html += `<li>
                            <span class="tree-item tree-file">${key}</span>
                            <span class="file-size">(${item.size})</span>
                         </li>`;
            }
        }
        html += '</ul>';
        return html;
    }

    /**
     * å…ƒæ•°æ®æŸ¥æ‰¾: æ˜¾ç¤ºæœç´¢ç»“æœ (é€‚é…çº¯hashå’Œæ ‘çŠ¶æ–‡ä»¶åˆ—è¡¨)
     * @param {Array} results - æœç´¢ç»“æœæ•°ç»„
     */
    function displaySearchResults(results) {
        const container = document.getElementById('search-results');
        container.innerHTML = '';

        if (!results || results.length === 0) {
            container.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœã€‚</p>';
            return;
        }

        results.forEach(item => {
            let cardHTML;
            if (item.name) { // æœ‰å®Œæ•´å…ƒæ•°æ®
                const fileTree = buildFileTree(item.files);
                const fileListHTML = renderTreeToHTML(fileTree);
                // [BUGä¿®å¤] ç§»é™¤ file-list ä¸Šçš„å†…è” style å±æ€§
                cardHTML = `
                    <div class="torrent-card">
                        <h4>${item.name}</h4>
                        <p class="info-hash">Hash: ${item.info_hash}</p>
                        <div class="actions">
                            <button class="button" data-action="copy-hash" data-hash="${item.info_hash}">å¤åˆ¶Hash</button>
                            <button class="button" data-action="copy-magnet" data-hash="${item.info_hash}">å¤åˆ¶ç£åŠ›</button>
                            <button class="button" data-action="toggle-files">æŸ¥çœ‹æ–‡ä»¶</button>
                        </div>
                        <div class="file-list">${fileListHTML}</div>
                    </div>
                `;
            } else { // åªæœ‰ info_hash
                cardHTML = `
                    <div class="torrent-card minimal">
                        <h4>å…ƒæ•°æ®å¾…è·å–</h4>
                        <p class="info-hash">Hash: ${item.info_hash}</p>
                        <div class="actions">
                            <button class="button" data-action="copy-hash" data-hash="${item.info_hash}">å¤åˆ¶Hash</button>
                            <button class="button" data-action="copy-magnet" data-hash="${item.info_hash}">å¤åˆ¶ç£åŠ›</button>
                        </div>
                    </div>
                `;
            }
            container.innerHTML += cardHTML;
        });
    }

    /**
     * æ¸²æŸ“ç¿»é¡µæ§ä»¶
     * @param {number} totalPages - æ€»é¡µæ•°
     * @param {number} currentPage - å½“å‰é¡µç 
     */
    function renderPaginationControls(totalPages, currentPage) {
        const container = document.getElementById('pagination-controls');
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '';
        // ä¸Šä¸€é¡µ
        html += `<a href="#" class="pagination-link ${currentPage === 1 ? 'disabled' : ''}" data-page="${currentPage - 1}">ä¸Šä¸€é¡µ</a>`;

        // é¡µç 
        // ç®€å•é€»è¾‘ï¼šåªæ˜¾ç¤ºå½“å‰é¡µå‰åå‡ é¡µ
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) html += `<a href="#" class="pagination-link" data-page="1">1</a>`;
        if (startPage > 2) html += `<span class="pagination-link disabled">...</span>`;

        for (let i = startPage; i <= endPage; i++) {
            html += `<a href="#" class="pagination-link ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</a>`;
        }

        if (endPage < totalPages - 1) html += `<span class="pagination-link disabled">...</span>`;
        if (endPage < totalPages) html += `<a href="#" class="pagination-link" data-page="${totalPages}">${totalPages}</a>`;

        // ä¸‹ä¸€é¡µ
        html += `<a href="#" class="pagination-link ${currentPage === totalPages ? 'disabled' : ''}" data-page="${currentPage + 1}">ä¸‹ä¸€é¡µ</a>`;
        
        container.innerHTML = html;
    }

    // --- [æ–°å¢] å·¥å…·ç›¸å…³å‡½æ•° ---

    /**
     * ç”ŸæˆæŒ‡å®šé•¿åº¦çš„éšæœºåå…­è¿›åˆ¶å­—ç¬¦ä¸².
     * @param {number} numBytes - å­—èŠ‚æ•° (ä¾‹å¦‚, 20 for InfoHash/NodeID).
     * @returns {string} 2 * numBytes é•¿åº¦çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸².
     */
    function generateRandomHex(numBytes) {
        const buffer = new Uint8Array(numBytes);
        window.crypto.getRandomValues(buffer);
        return Array.from(buffer, byte => byte.toString(16).padStart(2, '0')).join('');
    }

    /**
     * å¤„ç†æ‰‹åŠ¨å·¥å…·çš„è¯·æ±‚.
     * @param {string} toolName - å·¥å…·åç§°, e.g., 'ping', 'get_peers'.
     */
    async function handleToolRequest(toolName) {
        // å°† get_peers è½¬æ¢ä¸º getpeers ä»¥åŒ¹é…å…ƒç´ ID
        const responseEl = document.getElementById(`tools-${toolName.replace('_', '-')}-response`);
        if (!responseEl) return;

        responseEl.textContent = 'æ­£åœ¨å‘é€è¯·æ±‚...';

        const endpoint = `/api/v1/tools/${toolName}`;
        let payload = {};

        try {
            // æ ¹æ®å·¥å…·åç§°æ„å»º payload
            switch (toolName) {
                case 'ping':
                    payload.address = document.getElementById('tools-ping-addr-input').value;
                    if (!payload.address) throw new Error('èŠ‚ç‚¹åœ°å€ä¸èƒ½ä¸ºç©º');
                    break;
                case 'get_peers':
                    payload.address = document.getElementById('tools-getpeers-addr-input').value;
                    payload.info_hash = document.getElementById('tools-getpeers-hash-input').value;
                    if (!payload.address || !payload.info_hash) throw new Error('åœ°å€å’Œ Info Hash ä¸èƒ½ä¸ºç©º');
                    break;
                case 'announce_peer':
                    payload.address = document.getElementById('tools-announce-addr-input').value;
                    payload.info_hash = document.getElementById('tools-announce-hash-input').value;
                    const port = document.getElementById('tools-announce-port-input').value;
                    if (!payload.address || !payload.info_hash || !port) throw new Error('åœ°å€ã€Info Hash å’Œç«¯å£ä¸èƒ½ä¸ºç©º');
                    payload.port = parseInt(port, 10);
                    break;
                case 'sample_infohashes':
                    payload.address = document.getElementById('tools-sample-addr-input').value;
                    payload.target = document.getElementById('tools-sample-target-input').value;
                    if (!payload.address || !payload.target) throw new Error('åœ°å€å’Œç›®æ ‡ Node ID ä¸èƒ½ä¸ºç©º');
                    break;
                default:
                    throw new Error(`æœªçŸ¥çš„å·¥å…·: ${toolName}`);
            }

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const responseData = await response.json();

            if (!response.ok) {
                // å¦‚æœåç«¯è¿”å›äº†å¸¦ error å­—æ®µçš„ JSONï¼Œå°±æ˜¾ç¤ºå®ƒï¼Œå¦åˆ™æ˜¾ç¤ºé€šç”¨HTTPé”™è¯¯
                throw new Error(responseData.error || `HTTP é”™è¯¯: ${response.status}`);
            }

            // æˆåŠŸï¼Œæ ¼å¼åŒ–å¹¶æ˜¾ç¤º JSON
            responseEl.textContent = JSON.stringify(responseData, null, 2);

        } catch (err) {
            responseEl.textContent = `é”™è¯¯: ${err.message}`;
        }
    }


    // ... (loadSettings, saveSettings å‡½æ•°ä¸ä¹‹å‰ç‰ˆæœ¬ç›¸åŒ)
    async function loadSettings() {
        try {
            const response = await fetch('/api/v1/get_config');
            if (!response.ok) {
                console.log('Error:', response.statusText);
                return;
            }
            const config = await response.json();
            const port = config['webui_port'];
            const addr = config['bind_addr'];
            const id = config['node_id'];

            document.getElementById('webui-port-input').value = port;
            document.getElementById('bind-addr-input').value = addr;
            document.getElementById('node-id-input').value = id;
        }
        catch (e) {
            console.log(e);
        }
    }
    async function saveSettings() {
        addLog("æ­£åœ¨ä¿å­˜è®¾ç½®...");
        const port = document.getElementById('webui-port-input').value;
        const addr = document.getElementById('bind-addr-input').value;
        const id = document.getElementById('node-id-input').value;

        try {
            const response = await fetch('/api/v1/set_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ webui_port: parseInt(port), bind_addr: addr, node_id: id })
            });
            const text = await response.text();

            if (!response.ok) {
                alert(`Error: ${text}`);
                return;
            }
            if (!response.text === "OK") {
                alert(`Error: ${text}`);
                return;
            }

            addLog("è®¾ç½®ä¿å­˜æˆåŠŸ");
        }
        catch (e) {
            console.log(e);
        }
    }
</script>

</body>
</html>